name: Build Pip Reroller EXE

on:
  workflow_dispatch:
    inputs:
      script_path:
        description: 'Relative path to Python script (e.g., KC-Tool-Suite/pip_reroller/pip_reroller_v1/pip_reroller_v1.0.0.py)'
        required: true
      release_tag:
        description: 'Git tag to release (e.g., v1.1.0)'
        required: true
      release_title:
        description: 'Release title (e.g., Pip Reroller v1.1.0)'
        required: true

jobs:
  build:
    name: Build EXE with Nuitka
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka
          pip install tk

      - name: Build with Nuitka
        run: |
          $script = "${{ github.event.inputs.script_path }}"
          $basename = [System.IO.Path]::GetFileNameWithoutExtension($script)
          $icon_path = "assets/kc-tool-suite/PIPRR_Icon_Variable.ico"

          python -m nuitka `
            "$script" `
            --standalone `
            --onefile `
            --nofollow-imports `
            --enable-plugin=tk-inter `
            --windows-icon-from-ico="$icon_path" `
            --windows-disable-console `
            --remove-output `
            --assume-yes-for-downloads `
            --noinclude-dlls=*
          
          echo "::set-output name=exe_name::$basename.exe"

      - name: Compute SHA256
        id: checksum
        run: |
          $exe = Get-ChildItem *.exe | Select-Object -First 1
          $hash = Get-FileHash $exe.FullName -Algorithm SHA256
          $hash.Hash | Out-File -Encoding ascii -FilePath "$($exe.BaseName).sha256"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_title }}
          files: |
            *.exe
            *.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
